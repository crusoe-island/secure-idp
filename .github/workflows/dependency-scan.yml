# =============================================================================

# Dependency Security Scanning Workflow

# Scans project dependencies for known vulnerabilities and license issues

# =============================================================================

name: Dependency Security Scan

on:

# Run on pull requests

pull_request:
branches:
- main
- master
- develop
paths:
- â€˜**/package.jsonâ€™
- â€™**/package-lock.jsonâ€™
- â€˜**/yarn.lockâ€™
- â€™**/requirements.txtâ€™
- â€˜**/requirements*.txtâ€™
- â€™**/Pipfileâ€™
- â€˜**/Pipfile.lockâ€™
- â€™**/poetry.lockâ€™
- â€˜**/pyproject.tomlâ€™
- â€™**/go.modâ€™
- â€˜**/go.sumâ€™
- â€™**/Gemfileâ€™
- â€˜**/Gemfile.lockâ€™
- â€™**/pom.xmlâ€™
- â€˜**/build.gradleâ€™
- â€™**/build.gradle.ktsâ€™
- â€˜.github/workflows/dependency-scan.ymlâ€™

# Run on push to main/master

push:
branches:
- main
- master
paths:
- â€˜**/package.jsonâ€™
- â€™**/requirements.txtâ€™
- â€˜**/go.modâ€™

# Allow manual trigger

workflow_dispatch:

# Run on schedule (daily)

schedule:
- cron: â€˜0 3 * * *â€™  # Every day at 3 AM UTC

# Permissions for security scanning

permissions:
contents: read
security-events: write
pull-requests: write
issues: write

env:
PYTHON_VERSION: â€˜3.11â€™
NODE_VERSION: â€˜18â€™
GO_VERSION: â€˜1.21â€™

jobs:

# ===========================================================================

# Job 1: Detect Project Languages

# ===========================================================================

detect-languages:
name: Detect Project Languages
runs-on: ubuntu-latest
outputs:
has-python: ${{ steps.detect.outputs.has-python }}
has-node: ${{ steps.detect.outputs.has-node }}
has-go: ${{ steps.detect.outputs.has-go }}
has-java: ${{ steps.detect.outputs.has-java }}
has-ruby: ${{ steps.detect.outputs.has-ruby }}

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  - name: Detect languages
    id: detect
    run: |
      # Python
      if find . -name "requirements*.txt" -o -name "Pipfile" -o -name "pyproject.toml" | grep -q .; then
        echo "has-python=true" >> $GITHUB_OUTPUT
      else
        echo "has-python=false" >> $GITHUB_OUTPUT
      fi
      
      # Node.js
      if find . -name "package.json" | grep -q .; then
        echo "has-node=true" >> $GITHUB_OUTPUT
      else
        echo "has-node=false" >> $GITHUB_OUTPUT
      fi
      
      # Go
      if find . -name "go.mod" | grep -q .; then
        echo "has-go=true" >> $GITHUB_OUTPUT
      else
        echo "has-go=false" >> $GITHUB_OUTPUT
      fi
      
      # Java
      if find . -name "pom.xml" -o -name "build.gradle" | grep -q .; then
        echo "has-java=true" >> $GITHUB_OUTPUT
      else
        echo "has-java=false" >> $GITHUB_OUTPUT
      fi
      
      # Ruby
      if find . -name "Gemfile" | grep -q .; then
        echo "has-ruby=true" >> $GITHUB_OUTPUT
      else
        echo "has-ruby=false" >> $GITHUB_OUTPUT
      fi
```

# ===========================================================================

# Job 2: OWASP Dependency Check

# ===========================================================================

owasp-dependency-check:
name: OWASP Dependency Check
runs-on: ubuntu-latest

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  - name: Run OWASP Dependency Check
    uses: dependency-check/Dependency-Check_Action@main
    id: depcheck
    with:
      project: 'secure-idp'
      path: '.'
      format: 'ALL'
      args: >
        --enableRetired
        --enableExperimental
        --failOnCVSS 7
        --suppression dependency-check-suppressions.xml
    continue-on-error: true
  
  - name: Upload OWASP Dependency Check Results
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: owasp-dependency-check-report
      path: |
        ${{ github.workspace }}/reports/dependency-check-report.html
        ${{ github.workspace }}/reports/dependency-check-report.json
        ${{ github.workspace }}/reports/dependency-check-report.xml
        ${{ github.workspace }}/reports/dependency-check-report.sarif
      retention-days: 30
  
  - name: Upload SARIF to GitHub Security
    if: always()
    uses: github/codeql-action/upload-sarif@v3
    with:
      sarif_file: ${{ github.workspace }}/reports/dependency-check-report.sarif
      category: owasp-dependency-check
```

# ===========================================================================

# Job 3: Python Dependency Scan (Safety & pip-audit)

# ===========================================================================

python-dependencies:
name: Python Dependency Scan
runs-on: ubuntu-latest
needs: detect-languages
if: needs.detect-languages.outputs.has-python == â€˜trueâ€™

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: ${{ env.PYTHON_VERSION }}
  
  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      if [ -f requirements.txt ]; then
        pip install -r requirements.txt
      fi
      if [ -f requirements-dev.txt ]; then
        pip install -r requirements-dev.txt
      fi
  
  - name: Run Safety Check
    run: |
      pip install safety
      safety check --json --output safety-report.json || true
      safety check --output safety-report.txt || true
    continue-on-error: true
  
  - name: Run pip-audit
    run: |
      pip install pip-audit
      pip-audit --format json --output pip-audit-report.json || true
      pip-audit --format cyclonedx-json --output pip-audit-sbom.json || true
    continue-on-error: true
  
  - name: Run Bandit (Python security linter)
    run: |
      pip install bandit[toml]
      bandit -r . -f json -o bandit-report.json || true
      bandit -r . -f sarif -o bandit-results.sarif || true
    continue-on-error: true
  
  - name: Upload Bandit SARIF
    if: always()
    uses: github/codeql-action/upload-sarif@v3
    with:
      sarif_file: bandit-results.sarif
      category: bandit
  
  - name: Check for critical vulnerabilities
    run: |
      if [ -f safety-report.json ]; then
        CRITICAL=$(cat safety-report.json | jq '[.vulnerabilities[] | select(.severity=="critical")] | length')
        HIGH=$(cat safety-report.json | jq '[.vulnerabilities[] | select(.severity=="high")] | length')
        
        echo "ðŸ” Python Vulnerability Summary:"
        echo "  CRITICAL: $CRITICAL"
        echo "  HIGH: $HIGH"
        
        if [ "$CRITICAL" -gt 0 ]; then
          echo "âŒ CRITICAL vulnerabilities found in Python dependencies"
          exit 1
        fi
      fi
    continue-on-error: true
  
  - name: Upload Python Security Reports
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: python-security-reports
      path: |
        safety-report.json
        safety-report.txt
        pip-audit-report.json
        pip-audit-sbom.json
        bandit-report.json
      retention-days: 30
```

# ===========================================================================

# Job 4: Node.js Dependency Scan (npm audit & Snyk)

# ===========================================================================

nodejs-dependencies:
name: Node.js Dependency Scan
runs-on: ubuntu-latest
needs: detect-languages
if: needs.detect-languages.outputs.has-node == â€˜trueâ€™

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  - name: Set up Node.js
    uses: actions/setup-node@v4
    with:
      node-version: ${{ env.NODE_VERSION }}
  
  - name: Install dependencies
    run: |
      if [ -f package-lock.json ]; then
        npm ci
      elif [ -f yarn.lock ]; then
        yarn install --frozen-lockfile
      else
        npm install
      fi
  
  - name: Run npm audit
    run: |
      npm audit --json > npm-audit-report.json || true
      npm audit > npm-audit-report.txt || true
    continue-on-error: true
  
  - name: Check npm audit results
    run: |
      if [ -f npm-audit-report.json ]; then
        CRITICAL=$(cat npm-audit-report.json | jq '.metadata.vulnerabilities.critical // 0')
        HIGH=$(cat npm-audit-report.json | jq '.metadata.vulnerabilities.high // 0')
        
        echo "ðŸ” Node.js Vulnerability Summary:"
        echo "  CRITICAL: $CRITICAL"
        echo "  HIGH: $HIGH"
        
        if [ "$CRITICAL" -gt 0 ]; then
          echo "âŒ CRITICAL vulnerabilities found in Node.js dependencies"
          # Uncomment to fail on critical vulnerabilities
          # exit 1
        fi
      fi
    continue-on-error: true
  
  - name: Run Retire.js (JavaScript library checker)
    run: |
      npm install -g retire
      retire --js --node --outputformat json --outputpath retire-report.json || true
      retire --js --node --outputpath retire-report.txt || true
    continue-on-error: true
  
  - name: Generate npm SBOM
    run: |
      npm install -g @cyclonedx/cyclonedx-npm
      cyclonedx-npm --output-file npm-sbom.json || true
    continue-on-error: true
  
  - name: Upload Node.js Security Reports
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: nodejs-security-reports
      path: |
        npm-audit-report.json
        npm-audit-report.txt
        retire-report.json
        retire-report.txt
        npm-sbom.json
      retention-days: 30
```

# ===========================================================================

# Job 5: Go Dependency Scan (govulncheck & nancy)

# ===========================================================================

go-dependencies:
name: Go Dependency Scan
runs-on: ubuntu-latest
needs: detect-languages
if: needs.detect-languages.outputs.has-go == â€˜trueâ€™

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  - name: Set up Go
    uses: actions/setup-go@v5
    with:
      go-version: ${{ env.GO_VERSION }}
  
  - name: Install govulncheck
    run: go install golang.org/x/vuln/cmd/govulncheck@latest
  
  - name: Run govulncheck
    run: |
      govulncheck -json ./... > govulncheck-report.json || true
      govulncheck ./... > govulncheck-report.txt || true
    continue-on-error: true
  
  - name: Install Nancy (Sonatype)
    run: |
      curl -L -o nancy https://github.com/sonatype-nexus-community/nancy/releases/latest/download/nancy-linux-amd64
      chmod +x nancy
      sudo mv nancy /usr/local/bin/
  
  - name: Run Nancy
    run: |
      go list -json -deps ./... | nancy sleuth -o json > nancy-report.json || true
      go list -json -deps ./... | nancy sleuth > nancy-report.txt || true
    continue-on-error: true
  
  - name: Upload Go Security Reports
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: go-security-reports
      path: |
        govulncheck-report.json
        govulncheck-report.txt
        nancy-report.json
        nancy-report.txt
      retention-days: 30
```

# ===========================================================================

# Job 6: Snyk Dependency Scan (Multi-Language)

# ===========================================================================

snyk-scan:
name: Snyk Dependency Scan
runs-on: ubuntu-latest
if: github.event_name == â€˜pull_requestâ€™ || github.event_name == â€˜pushâ€™

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  - name: Run Snyk to check for vulnerabilities
    uses: snyk/actions/node@master
    continue-on-error: true
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    with:
      args: --severity-threshold=high --all-projects
  
  - name: Upload Snyk results to GitHub Code Scanning
    if: always()
    uses: github/codeql-action/upload-sarif@v3
    with:
      sarif_file: snyk.sarif
      category: snyk-dependencies
```

# ===========================================================================

# Job 7: License Compliance Check

# ===========================================================================

license-check:
name: License Compliance Check
runs-on: ubuntu-latest
needs: detect-languages

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  # Python license check
  - name: Python License Check
    if: needs.detect-languages.outputs.has-python == 'true'
    run: |
      pip install pip-licenses
      pip-licenses --format=json --output-file=python-licenses.json || true
      pip-licenses --format=markdown --output-file=python-licenses.md || true
      
      # Check for GPL licenses (example - adjust based on your policy)
      pip-licenses | grep -i "gpl" > gpl-licenses.txt || true
    continue-on-error: true
  
  # Node.js license check
  - name: Node.js License Check
    if: needs.detect-languages.outputs.has-node == 'true'
    run: |
      npm install -g license-checker
      license-checker --json --out nodejs-licenses.json || true
      license-checker --markdown --out nodejs-licenses.md || true
      
      # Check for problematic licenses
      license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC' --production || true
    continue-on-error: true
  
  # Go license check
  - name: Go License Check
    if: needs.detect-languages.outputs.has-go == 'true'
    run: |
      go install github.com/google/go-licenses@latest
      go-licenses report ./... --template=licenses.tpl > go-licenses.txt || true
    continue-on-error: true
  
  - name: Check for restrictive licenses
    run: |
      echo "# ðŸ“œ License Compliance Report" > license-summary.md
      echo "" >> license-summary.md
      
      if [ -f gpl-licenses.txt ]; then
        GPL_COUNT=$(cat gpl-licenses.txt | wc -l)
        if [ "$GPL_COUNT" -gt 0 ]; then
          echo "âš ï¸ **Warning:** Found $GPL_COUNT GPL-licensed dependencies" >> license-summary.md
          echo "" >> license-summary.md
          cat gpl-licenses.txt >> license-summary.md
        fi
      fi
  
  - name: Upload License Reports
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: license-reports
      path: |
        python-licenses.json
        python-licenses.md
        nodejs-licenses.json
        nodejs-licenses.md
        go-licenses.txt
        license-summary.md
      retention-days: 90
```

# ===========================================================================

# Job 8: Outdated Dependencies Check

# ===========================================================================

outdated-check:
name: Outdated Dependencies
runs-on: ubuntu-latest
needs: detect-languages
if: github.event_name == â€˜scheduleâ€™ || github.event_name == â€˜workflow_dispatchâ€™

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  # Python outdated check
  - name: Check outdated Python packages
    if: needs.detect-languages.outputs.has-python == 'true'
    run: |
      pip install pip-review
      pip-review --auto --raw > python-outdated.txt || true
    continue-on-error: true
  
  # Node.js outdated check
  - name: Check outdated Node.js packages
    if: needs.detect-languages.outputs.has-node == 'true'
    run: |
      npm outdated --json > nodejs-outdated.json || true
      npm outdated > nodejs-outdated.txt || true
    continue-on-error: true
  
  # Go outdated check
  - name: Check outdated Go modules
    if: needs.detect-languages.outputs.has-go == 'true'
    run: |
      go list -u -m -json all > go-outdated.json || true
    continue-on-error: true
  
  - name: Create issue for outdated dependencies
    if: always()
    uses: actions/github-script@v7
    with:
      script: |
        const fs = require('fs');
        let outdatedFound = false;
        let body = '# ðŸ“¦ Outdated Dependencies Report\n\n';
        body += `**Generated:** ${new Date().toISOString()}\n\n`;
        
        // Check Python
        if (fs.existsSync('python-outdated.txt')) {
          const content = fs.readFileSync('python-outdated.txt', 'utf8');
          if (content.trim()) {
            outdatedFound = true;
            body += '## Python Packages\n\n```\n' + content + '\n```\n\n';
          }
        }
        
        // Check Node.js
        if (fs.existsSync('nodejs-outdated.json')) {
          const content = fs.readFileSync('nodejs-outdated.json', 'utf8');
          if (content.trim() && content !== '{}') {
            outdatedFound = true;
            body += '## Node.js Packages\n\n```json\n' + content + '\n```\n\n';
          }
        }
        
        if (outdatedFound) {
          // Check if issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'dependencies,outdated'
          });
          
          if (issues.data.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“¦ Outdated Dependencies Detected',
              body: body,
              labels: ['dependencies', 'outdated', 'security']
            });
          }
        }
  
  - name: Upload Outdated Reports
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: outdated-dependencies
      path: |
        python-outdated.txt
        nodejs-outdated.json
        nodejs-outdated.txt
        go-outdated.json
      retention-days: 30
```

# ===========================================================================

# Job 9: Dependabot Alert Check

# ===========================================================================

dependabot-alerts:
name: Check Dependabot Alerts
runs-on: ubuntu-latest
if: github.event_name == â€˜scheduleâ€™ || github.event_name == â€˜workflow_dispatchâ€™

```
steps:
  - name: Check for open Dependabot alerts
    uses: actions/github-script@v7
    with:
      script: |
        const alerts = await github.rest.dependabot.listAlertsForRepo({
          owner: context.repo.owner,
          repo: context.repo.repo,
          state: 'open'
        });
        
        console.log(`Found ${alerts.data.length} open Dependabot alerts`);
        
        // Group by severity
        const critical = alerts.data.filter(a => a.security_advisory.severity === 'critical');
        const high = alerts.data.filter(a => a.security_advisory.severity === 'high');
        const medium = alerts.data.filter(a => a.security_advisory.severity === 'medium');
        const low = alerts.data.filter(a => a.security_advisory.severity === 'low');
        
        console.log(`  CRITICAL: ${critical.length}`);
        console.log(`  HIGH: ${high.length}`);
        console.log(`  MEDIUM: ${medium.length}`);
        console.log(`  LOW: ${low.length}`);
        
        // Fail if critical alerts exist
        if (critical.length > 0) {
          core.setFailed(`${critical.length} CRITICAL Dependabot alerts found!`);
        }
```

# ===========================================================================

# Job 10: Dependency Graph Update

# ===========================================================================

dependency-graph:
name: Update Dependency Graph
runs-on: ubuntu-latest
if: github.event_name == â€˜pushâ€™ && github.ref == â€˜refs/heads/mainâ€™

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  - name: Submit dependency graph (Python)
    uses: actions/dependency-review-action@v4
    with:
      fail-on-severity: high
  
  - name: Generate dependency tree
    run: |
      echo "# Dependency Tree" > dependency-tree.md
      echo "" >> dependency-tree.md
      
      # Python
      if [ -f requirements.txt ]; then
        echo "## Python Dependencies" >> dependency-tree.md
        pip install pipdeptree
        pipdeptree --graph-output png > python-dep-tree.png || true
        pipdeptree >> dependency-tree.md || true
      fi
      
      # Node.js
      if [ -f package.json ]; then
        echo "## Node.js Dependencies" >> dependency-tree.md
        npm list --all >> dependency-tree.md || true
      fi
    continue-on-error: true
  
  - name: Upload dependency tree
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: dependency-tree
      path: |
        dependency-tree.md
        python-dep-tree.png
      retention-days: 90
```

# ===========================================================================

# Job 11: Security Summary Report

# ===========================================================================

security-summary:
name: Dependency Security Summary
runs-on: ubuntu-latest
needs: [owasp-dependency-check, python-dependencies, nodejs-dependencies, go-dependencies, license-check]
if: always()

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  - name: Download all reports
    uses: actions/download-artifact@v4
    with:
      path: ./reports/
    continue-on-error: true
  
  - name: Generate Security Summary
    run: |
      echo "# ðŸ”’ Dependency Security Scan Summary" > security-summary.md
      echo "" >> security-summary.md
      echo "**Scan Date:** $(date)" >> security-summary.md
      echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
      echo "**Commit:** ${{ github.sha }}" >> security-summary.md
      echo "" >> security-summary.md
      
      # Python vulnerabilities
      if [ -f "./reports/python-security-reports/safety-report.json" ]; then
        echo "## ðŸ Python Dependencies" >> security-summary.md
        VULN_COUNT=$(cat ./reports/python-security-reports/safety-report.json | jq '.vulnerabilities | length' || echo "0")
        echo "- Vulnerabilities found: $VULN_COUNT" >> security-summary.md
        echo "" >> security-summary.md
      fi
      
      # Node.js vulnerabilities
      if [ -f "./reports/nodejs-security-reports/npm-audit-report.json" ]; then
        echo "## ðŸ“¦ Node.js Dependencies" >> security-summary.md
        CRITICAL=$(cat ./reports/nodejs-security-reports/npm-audit-report.json | jq '.metadata.vulnerabilities.critical // 0')
        HIGH=$(cat ./reports/nodejs-security-reports/npm-audit-report.json | jq '.metadata.vulnerabilities.high // 0')
        MEDIUM=$(cat ./reports/nodejs-security-reports/npm-audit-report.json | jq '.metadata.vulnerabilities.medium // 0')
        echo "- ðŸ”´ CRITICAL: $CRITICAL" >> security-summary.md
        echo "- ðŸŸ  HIGH: $HIGH" >> security-summary.md
        echo "- ðŸŸ¡ MEDIUM: $MEDIUM" >> security-summary.md
        echo "" >> security-summary.md
      fi
      
      # License compliance
      if [ -f "./reports/license-reports/license-summary.md" ]; then
        echo "## ðŸ“œ License Compliance" >> security-summary.md
        cat ./reports/license-reports/license-summary.md >> security-summary.md
        echo "" >> security-summary.md
      fi
      
      echo "## ðŸ“Š Recommendations" >> security-summary.md
      echo "" >> security-summary.md
      echo "1. Update dependencies with CRITICAL vulnerabilities immediately" >> security-summary.md
      echo "2. Review and plan updates for HIGH severity vulnerabilities" >> security-summary.md
      echo "3. Consider updating all outdated dependencies" >> security-summary.md
      echo "4. Review license compliance issues" >> security-summary.md
      echo "5. Enable Dependabot for automated updates" >> security-summary.md
  
  - name: Comment Security Summary on PR
    if: github.event_name == 'pull_request'
    uses: actions/github-script@v7
    with:
      script: |
        const fs = require('fs');
        const summary = fs.readFileSync('security-summary.md', 'utf8');
        
        github.rest.issues.createComment({
          issue_number: context.issue.number,
          owner: context.repo.owner,
          repo: context.repo.repo,
          body: summary
        })
  
  - name: Upload Security Summary
    uses: actions/upload-artifact@v4
    with:
      name: dependency-security-summary
      path: security-summary.md
      retention-days: 90
```

# =============================================================================

# Workflow Summary

# =============================================================================

# 

# This workflow performs comprehensive dependency security scanning:

# 

# 1. Language Detection - Identifies project languages

# 2. OWASP Dependency Check - Universal dependency scanner

# 3. Python Dependencies - Safety, pip-audit, Bandit

# 4. Node.js Dependencies - npm audit, Retire.js

# 5. Go Dependencies - govulncheck, Nancy

# 6. Snyk Scan - Multi-language vulnerability scanning

# 7. License Compliance - Check for restrictive licenses

# 8. Outdated Check - Find outdated dependencies (scheduled)

# 9. Dependabot Alerts - Monitor GitHub Dependabot

# 10. Dependency Graph - Update GitHub dependency graph

# 11. Security Summary - Aggregate all findings

# 

# Required Secrets:

# - GITHUB_TOKEN: Automatically provided by GitHub Actions

# - SNYK_TOKEN: Snyk API token (optional)

# 

# Artifacts Generated:

# - OWASP Dependency Check reports (HTML, JSON, SARIF)

# - Python security reports (Safety, pip-audit, Bandit)

# - Node.js security reports (npm audit, Retire.js)

# - Go security reports (govulncheck, Nancy)

# - License compliance reports

# - Outdated dependencies lists

# - Dependency tree visualization

# - Security summary report

# 

# =============================================================================
